<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Trout Area Simulator</title>
    
    <link rel="stylesheet" href="https://pyscript.net/releases/2023.05.1/pyscript.css" />
    <script defer src="https://pyscript.net/releases/2023.05.1/pyscript.js"></script>

    <style>
        :root { --sidebar-width: 350px; --primary: #28a745; --bg: #f0f2f5; }
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); overflow-x: hidden; }
        
        .app-container { display: flex; flex-direction: column; min-height: 100vh; }
        
        /* PLOT AREA */
        .main-area { order: 1; width: 100%; background: white; padding-bottom: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); z-index: 2; }
        
        #plot-area { 
            width: 100%;
            display: flex; 
            justify-content: center; 
            margin: 0; 
            padding: 0; 
        }
        
        #cheat-sheet-container { padding: 10px 15px; }
        
        #cheat-sheet { 
            background: #e8f5e9; 
            border-left: 5px solid var(--primary); 
            padding: 12px; 
            border-radius: 4px; 
            font-family: monospace; 
            font-size: 0.9rem; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        /* CONTROLS */
        .sidebar { order: 2; padding: 15px; background: var(--bg); padding-bottom: 80px; }

        @media (min-width: 900px) {
            .app-container { flex-direction: row; height: 100vh; overflow: hidden; }
            .sidebar { order: 1; width: var(--sidebar-width); height: 100%; overflow-y: auto; border-right: 1px solid #ddd; padding-bottom: 20px; background: white; }
            .main-area { order: 2; flex: 1; height: 100%; overflow-y: auto; padding: 20px; background: var(--bg); }
            #plot-area { width: 100%; max-width: 900px; border-radius: 12px; overflow: hidden; min-width: auto; }
        }

        /* TABS */
        .tabs { display: flex; background: #e0e0e0; border-radius: 8px; padding: 4px; margin-bottom: 15px; }
        .tab-button { flex: 1; padding: 10px; text-align: center; background: transparent; border: none; font-weight: 600; cursor: pointer; border-radius: 6px; font-size: 0.9rem; color: #555; }
        .tab-button.active { background: white; color: var(--primary); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* STICKY HEADER */
        .mobile-sticky-header {
            display: none; /* Hidden on desktop */
            position: sticky;
            top: 0;
            background: var(--bg);
            padding: 10px 0;
            z-index: 10;
            border-bottom: 1px solid #ddd;
        }

        @media (max-width: 899px) {
            .mobile-sticky-header { display: block; }
            .main-area { padding-top: 0; }
        }

        /* WIDGETS */
        .widget-card { margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; background: white; overflow: hidden; padding: 15px; }
        .control-group { margin-bottom: 15px; position: relative; }
        label { display: block; font-size: 0.8rem; color: #666; margin-bottom: 5px; font-weight: 500; }
        .input-row { display: flex; gap: 8px; align-items: center; }
        input[type=range] { flex: 1; height: 5px; background: #ddd; -webkit-appearance: none; appearance: none; border-radius: 5px; outline: none; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: var(--primary); border-radius: 50%; cursor: pointer; border: 3px solid white; box-shadow: 0 1px 4px rgba(0,0,0,0.3); }
        input[type=range]::-moz-range-thumb { width: 20px; height: 20px; background: var(--primary); border-radius: 50%; cursor: pointer; border: 3px solid white; box-shadow: 0 1px 4px rgba(0,0,0,0.3); }
        
        input[type=number], select { width: 70px; padding: 8px; border: 1px solid #ccc; border-radius: 6px; font-size: 0.9rem; text-align: center; background: #f8f9fa; }
        select { width: 100%; text-align: left; }
        
        .action-bar { display: flex; gap: 10px; margin-bottom: 15px; }
        .btn-calc { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 1rem; cursor: pointer; }
        .btn-calc.secondary { background: #007bff; }
        .btn-calc:active { transform: translateY(1px); }

        #slider-tooltip {
            position: fixed;
            background: #333;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            pointer-events: none;
            transform: translate(-50%, -150%);
            display: none;
            z-index: 101;
        }

        #loader { position: fixed; inset: 0; background: white; z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        #debug-log { display:none; background: #333; color: #f88; padding: 10px; font-family: monospace; font-size: 0.8rem; margin: 10px; border-radius: 4px; white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="slider-tooltip"></div>
    <div id="loader"><div class="spinner"></div><p style="margin-top:10px; color:#666">Loading Physics...</p></div>

    <div class="app-container">
        <!-- PLOT AREA (now first in source for mobile) -->
        <div class="main-area">
            <!-- V48 UI-REWORK: Sticky header for mobile -->
            <div class="mobile-sticky-header">
                <div id="cheat-sheet-container-sticky">
                    <div id="cheat-sheet-sticky">Initializing...</div>
                </div>
            </div>
            <div id="cheat-sheet-container" style="display:none;"> <!-- Keep original for desktop -->
                <div id="cheat-sheet">Initializing Engine...</div>
            </div>

            <div id="debug-log"></div>
            <div id="plot-area"></div>
        </div>

        <!-- SIDEBAR -->
        <div class="sidebar">
            <!-- V51 ACTION BAR MOVE -->
            <div class="action-bar">
                <button id="btn-auto" class="btn-calc">‚ö° Auto-Optimize</button>
                <button id="btn-update" class="btn-calc secondary">Update Graph</button>
            </div>
            <!-- V48 UI-REWORK: Tabs -->
            <div class="tabs">
                <button class="tab-button active" data-tab="gear">1. Gear & Targets</button>
                <button class="tab-button" data-tab="manual">2. Manual Tweaks</button>
            </div>

            <!-- V48 UI-REWORK: Tab Content -->
            <div id="gear-tab" class="tab-content active">
                <div class="widget-card">
                    <div class="control-group">
                        <label>Line Type</label>
                        <select id="w_line">
                            <option value="Ester">Ester</option>
                            <option value="PE (Braid)">PE (Braid)</option>
                            <option value="Fluorocarbon">Fluorocarbon</option>
                            <option value="Nylon">Nylon</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label>Leader</label>
                        <select id="w_leader">
                            <option value="Fluorocarbon">Fluorocarbon</option>
                            <option value="Nylon">Nylon</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label>Lure Model</label>
                        <select id="w_shape">
                            <option value="Generic Standard">Generic Standard</option>
                            <option value="Rodio Craft NOA">Rodio Craft NOA</option>
                            <option value="Forest MIU">Forest MIU</option>
                            <option value="Jackall Tearo">Jackall Tearo</option>
                            <option value="Rodio Craft Jeckyll">Rodio Craft Jeckyll</option>
                            <option value="Generic Wide (High Lift)">Generic Wide</option>
                            <option value="Generic Slim (Low Lift)">Generic Slim</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label>Weight (g)</label>
                        <div class="input-row">
                            <input type="range" id="s_weight" min="0.5" max="5.0" step="0.1" value="1.5" oninput="i_weight.value=this.value">
                            <input type="number" id="i_weight" value="1.5" step="0.1" oninput="s_weight.value=this.value">
                        </div>
                    </div>
                    <div class="control-group">
                        <label>Line Dia (mm)</label>
                        <div class="input-row">
                            <input type="range" id="s_dia" min="0.04" max="0.20" step="0.01" value="0.10" oninput="i_dia.value=this.value">
                            <input type="number" id="i_dia" value="0.10" step="0.01" oninput="s_dia.value=this.value">
                        </div>
                    </div>
                    <div class="control-group">
                        <label>Cast Dist (m)</label>
                        <div class="input-row">
                            <input type="range" id="s_dist" min="10" max="50" step="1" value="20" oninput="i_dist.value=this.value">
                            <input type="number" id="i_dist" value="20" step="1" oninput="s_dist.value=this.value">
                        </div>
                    </div>
                    <div class="control-group">
                        <label>Target Depth (m)</label>
                        <div class="input-row">
                            <input type="range" id="s_target" min="0.5" max="5.0" step="0.1" value="2.0" oninput="i_target.value=this.value">
                            <input type="number" id="i_target" value="2.0" step="0.1" oninput="s_target.value=this.value">
                        </div>
                    </div>
                    <div class="control-group">
                        <label>Pond Depth (m)</label>
                        <div class="input-row">
                            <input type="range" id="s_pond" min="1.5" max="5.0" step="0.5" value="3.0" oninput="i_pond.value=this.value">
                            <input type="number" id="i_pond" value="3.0" step="0.5" oninput="s_pond.value=this.value">
                        </div>
                    </div>
                    <div class="control-group">
                        <label>Reel (cm/turn)</label>
                        <div class="input-row">
                            <input type="range" id="s_reel" min="50" max="90" step="1" value="64" oninput="i_reel.value=this.value">
                            <input type="number" id="i_reel" value="64" step="1" oninput="s_reel.value=this.value">
                        </div>
                    </div>
                </div>
            </div>

            <div id="manual-tab" class="tab-content">
                <div class="widget-card">
                    <div class="control-group">
                        <label>Start Speed (cm/s)</label>
                        <div class="input-row">
                            <input type="range" id="s_spd_s" min="20" max="140" step="5" value="70" oninput="i_spd_s.value=this.value">
                            <input type="number" id="i_spd_s" value="70" step="5" oninput="s_spd_s.value=this.value">
                        </div>
                    </div>
                    <div class="control-group">
                        <label>End Speed (cm/s)</label>
                        <div class="input-row">
                            <input type="range" id="s_spd_e" min="10" max="100" step="5" value="35" oninput="i_spd_e.value=this.value">
                            <input type="number" id="i_spd_e" value="35" step="5" oninput="s_spd_e.value=this.value">
                        </div>
                    </div>
                    <div style="margin: 15px 0; font-size:0.9rem;">
                        <input type="checkbox" id="w_rod_dyn" style="width:20px; height:20px; vertical-align:middle;"> 
                        <label style="display:inline; vertical-align:middle;">Dynamic Rod Move?</label>
                    </div>
                    <div class="control-group">
                        <label>Rod Start Height (m)</label>
                        <div class="input-row">
                            <input type="range" id="s_rod_s" min="0" max="3.5" step="0.1" value="1.5" oninput="i_rod_s.value=this.value">
                            <input type="number" id="i_rod_s" value="1.5" step="0.1" oninput="s_rod_s.value=this.value">
                        </div>
                    </div>
                    <div class="control-group">
                        <label>Rod End Height (m)</label>
                        <div class="input-row">
                            <input type="range" id="s_rod_e" min="0" max="3.5" step="0.1" value="0.0" oninput="i_rod_e.value=this.value">
                            <input type="number" id="i_rod_e" value="0.0" step="0.1" oninput="s_rod_e.value=this.value">
                        </div>
                    </div>
                    <div class="control-group">
                        <label>Start Reel Depth (m)</label>
                        <div class="input-row">
                            <input type="range" id="s_start_d" min="0.5" max="5.0" step="0.1" value="2.5" oninput="i_start_d.value=this.value">
                            <input type="number" id="i_start_d" value="2.5" step="0.1" oninput="s_start_d.value=this.value">
                        </div>
                    </div>
                    <div class="control-group">
                        <label>Trigger Dist (m)</label>
                        <div class="input-row">
                            <input type="range" id="s_trig" min="0" max="40" step="1" value="15" oninput="i_trig.value=this.value">
                            <input type="number" id="i_trig" value="15" step="1" oninput="s_trig.value=this.value">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <py-config>
        packages = ["matplotlib", "numpy"]
    </py-config>

    <py-script>
import matplotlib.pyplot as plt
import matplotlib.patches as patches
import numpy as np
import traceback
from js import document, window
from pyodide.ffi import create_proxy

# --- PHYSICS CONSTANTS ---
PHYSICS = {
    'gravity_scale': 0.28, 'lift_scale': 0.22, 'drag_scale': 0.04,
    'buoyancy_scale': 0.05, 'belly_tuning': 0.20, 'leader_lift': 0.015
}

def log_error(e):
    el = document.getElementById("debug-log")
    el.style.display = "block"
    el.innerHTML = f"PYTHON ERROR: {str(e)}"
    print(f"ERROR: {e}")

def calculate_physics_data(dist, actual_start_depth, line, diameter_mm, leader, 
                           rod_start, rod_end, rod_dynamic, rod_move_dist,
                           speed_start, speed_end, decel_dist, 
                           weight, shape_profile, 
                           steps=150, bottom_limit=-3.0):
    
    line_props = {
        "PE (Braid)":    {"sg": 0.97, "cd": 1.6, "belly": 2.2, "color": "green"}, 
        "Ester":         {"sg": 1.38, "cd": 1.0, "belly": 0.3, "color": "darkorange"},
        "Nylon":         {"sg": 1.14, "cd": 1.1, "belly": 1.0, "color": "red"}, 
        "Fluorocarbon":  {"sg": 1.78, "cd": 0.9, "belly": -0.6, "color": "blue"}
    }
    leader_props = {"Nylon": 0.05, "Fluorocarbon": -0.05} # Leader AoA effect
    shape_map = {
        "Rodio Craft NOA":     {"Cl": 1.5, "Stall": 18, "SinkFactor": 0.7, "AoA_Sens": 1.8},
        "Forest MIU":          {"Cl": 1.0, "Stall": 28, "SinkFactor": 1.0, "AoA_Sens": 1.0},
        "Jackall Tearo":       {"Cl": 1.1, "Stall": 25, "SinkFactor": 0.9, "AoA_Sens": 1.1},
        "Rodio Craft Jeckyll": {"Cl": 0.6, "Stall": 22, "SinkFactor": 1.2, "AoA_Sens": 0.8},
        "Generic Wide (High Lift)":    {"Cl": 1.4, "Stall": 15, "SinkFactor": 0.6, "AoA_Sens": 1.8},
        "Generic Standard":            {"Cl": 1.0, "Stall": 25, "SinkFactor": 1.0, "AoA_Sens": 1.0},
        "Generic Slim (Low Lift)":     {"Cl": 0.5, "Stall": 35, "SinkFactor": 1.3, "AoA_Sens": 0.5},
    }
    
    props = line_props[line]
    spoon_data = shape_map[shape_profile]
    spoon_cl = spoon_data["Cl"]
    stall_threshold = spoon_data["Stall"]
    sink_factor = spoon_data["SinkFactor"]
    aoa_sensitivity = spoon_data["AoA_Sens"]
    
    x = np.linspace(dist, 0, steps)
    dx = dist / steps
    y = []
    speeds = []
    rod_heights = []
    spoon_angles = []
    is_stalled = [] 
    initial_geometry = {} 
    
    current_depth = -abs(actual_start_depth)
    term_velocity = PHYSICS['gravity_scale'] * np.sqrt(weight / 1.5)
    effective_sink_rate = term_velocity * sink_factor
    area_lift_scaler = (weight / 1.5) ** 0.7
    dia_scale_drag = (diameter_mm / 0.10)
    dia_scale_vol = (diameter_mm / 0.10) ** 2

    for i, d in enumerate(x):
        if current_depth <= bottom_limit:
            remaining = steps - i
            y.extend([bottom_limit] * remaining)
            speeds.extend([0] * remaining)
            rod_heights.extend([rod_end if rod_dynamic else rod_start] * remaining)
            spoon_angles.extend([0] * remaining)
            is_stalled.extend([True] * remaining)
            break
            
        if d < 0.2:
            y.append(0); speeds.append(0); is_stalled.append(True); rod_heights.append(rod_start); spoon_angles.append(0)
            continue
            
        if rod_dynamic:
            if d > rod_move_dist: r_h = rod_start
            else:
                ratio_rod = 0 if rod_move_dist == 0 else d / rod_move_dist
                r_h = rod_end + ((rod_start - rod_end) * ratio_rod)
        else:
            r_h = rod_start
        
        rod_heights.append(r_h)

        total_drop = r_h + abs(current_depth)
        if total_drop <= 0.001: ratio_air = 0; entry_dist_x = d
        else: ratio_air = r_h / total_drop; entry_dist_x = d * ratio_air
        ratio_in_water = max(0, 1.0 - ratio_air)
        
        if i == 0:
            initial_geometry = {'rod_h': r_h, 'spoon_x': d, 'spoon_y': current_depth, 'entry_x': entry_dist_x}

        if d > decel_dist: v_cms = speed_start
        else:
            if decel_dist == 0: ratio = 0
            else: ratio = d / decel_dist
            v_cms = speed_end + ((speed_start - speed_end) * ratio)
        
        speeds.append(v_cms)
        v = max(0.01, v_cms / 100.0)
        dt = dx / v 
        
        if v_cms < stall_threshold:
            is_stalled.append(True); cl_effective = spoon_cl * 0.1
        else:
            is_stalled.append(False); cl_effective = spoon_cl

        dy = r_h - current_depth
        geo_angle = np.arctan(dy / d)
        
        spoon_angles.append(np.degrees(geo_angle))
        
        leader_aoa_mod = 0
        if d < 1.0: # Leader effect only close to the angler
            leader_aoa_mod = leader_props[leader]
        
        aoa_factor = 1.0 + (np.sin(geo_angle) * aoa_sensitivity) + leader_aoa_mod
        belly_impact = props['belly'] * (d / 25.0) * PHYSICS['belly_tuning'] * ratio_in_water
        effective_angle_sin = np.sin(geo_angle) + belly_impact
        
        delta_rod = (v * dt) * effective_angle_sin
        delta_grav = -effective_sink_rate * dt
        
        delta_lift = PHYSICS['lift_scale'] * (v**2) * cl_effective * area_lift_scaler * aoa_factor * dt
        delta_line_drag = PHYSICS['drag_scale'] * props['cd'] * (v**2) * dia_scale_drag * (d/25.0) * dt * ratio_in_water
        delta_buoy = PHYSICS['buoyancy_scale'] * (1.0 - props['sg']) * dia_scale_vol * (d/25.0) * dt * ratio_in_water
        
        delta_leader = 0 # This is now handled in AoA
        
        current_depth += (delta_rod + delta_grav + delta_lift + delta_line_drag + delta_buoy)
        if current_depth > 0: current_depth = 0
        y.append(current_depth)
        
    return x, y, speeds, props['color'], initial_geometry, rod_heights, spoon_angles

# --- OPTIMIZER ---
def optimize_technique(dist, target_depth, weight, shape, diameter, leader, line, pond_bottom):
    best_score = -99999
    best_params = {}

    profiles = []
    # V50 SLOWER OPTIMIZER: Added more, slower profiles
    if weight >= 2.0:
        if line == "PE (Braid)": profiles = [(80, 50), (70, 40), (60, 30), (90, 60)]
        else: profiles = [(120, 80), (100, 70), (90, 60), (80, 50), (70, 40)]
    elif weight >= 1.2:
        if "Slim" in shape or "Jeckyll" in shape: profiles = [(80, 60), (70, 50), (90, 70), (60, 40)]
        else: profiles = [(70, 40), (60, 30), (50, 25), (80, 50)]
    else:
        if line == "PE (Braid)": profiles = [(40, 15), (30, 15), (50, 25)]
        else: profiles = [(50, 20), (40, 20), (30, 15), (60, 30)]

    rod_opts = [(1.5, 0.0, True), (0.0, 0.0, False)]
    start_depths = [target_depth, min(target_depth + 0.5, abs(pond_bottom) - 0.2)]

    for spd_s, spd_e in profiles:
        for r_s, r_e, r_dyn in rod_opts:
            for s_depth in start_depths:
                for trig_pct in [0.6, 0.8]:
                    trigger_dist = dist * trig_pct
                    # Correct unpacking (7 return values)
                    x, y, _, _, _, _, _ = calculate_physics_data(
                        dist, s_depth, line, diameter, leader, r_s, r_e, r_dyn, trigger_dist, 
                        spd_s, spd_e, trigger_dist, weight, shape, 
                        steps=30, bottom_limit=pond_bottom
                    )
                    
                    min_depth = np.min(y)
                    if min_depth <= (pond_bottom + 0.1): score = -5000 
                    else:
                        target = -target_depth
                        tolerance = 0.3 
                        in_zone = [val for val in y if abs(val - target) <= tolerance]
                        score = (len(in_zone) / len(y)) * 100
                        # V50 SLOWER OPTIMIZER: Increased speed penalty significantly
                        score -= (spd_s * 0.2) 

                    if score > best_score:
                        best_score = score
                        best_params = {'spd_s': spd_s, 'spd_e': spd_e, 'rod_s': r_s, 'rod_e': r_e, 'rod_dyn': r_dyn, 'start_depth': s_depth, 'trigger_dist': trigger_dist, 'score': score}
    return best_params

# --- DOM HELPERS ---
def get_val(id):
    el = document.getElementById(id)
    if el.type == "checkbox": return el.checked
    if el.type == "number" or el.type == "range": return float(el.value)
    return el.value

def set_val(id, val):
    el = document.getElementById(id)
    if "s_" in id:
        document.getElementById(id).value = val
        document.getElementById(id.replace("s_", "i_")).value = val
    elif "i_" in id:
        document.getElementById(id).value = val
        document.getElementById(id.replace("i_", "s_")).value = val
    else: el.value = val
    if el.type == "checkbox": el.checked = val

# --- MAIN PLOT ---
def update_plot(event=None):
    try:
        line = get_val("w_line"); leader = get_val("w_leader"); shape = get_val("w_shape")
        weight = get_val("s_weight"); dia = get_val("s_dia"); reel_cm = int(get_val("s_reel"))
        dist = get_val("s_dist"); target_depth = get_val("s_target"); pond_depth = get_val("s_pond")
        start_depth = get_val("s_start_d"); trigger = get_val("s_trig")
        spd_s = get_val("s_spd_s"); spd_e = get_val("s_spd_e")
        rod_dyn = get_val("w_rod_dyn"); rod_s = get_val("s_rod_s"); rod_e = get_val("s_rod_e")
        p_bot = -pond_depth

        x, y, speeds, color, init_geo, rod_heights, angles = calculate_physics_data(
            dist, start_depth, line, dia, leader, rod_s, rod_e, rod_dyn, trigger,
            spd_s, spd_e, trigger, weight, shape, steps=150, bottom_limit=p_bot
        )

        # DYNAMIC WIDTH CALCULATION (Inches)
        is_mobile = window.innerWidth < 900
        plot_div = document.getElementById("plot-area")
        px_width = plot_div.clientWidth
        
        # Convert to inches (approx 100 DPI)
        fig_width_in = px_width / 100.0
        
        # Determine aspect ratio
        if is_mobile:
             # Mobile: Portrait (Height is 1.2x width)
             fig_height_in = fig_width_in * 1.2
        else:
             # Desktop: Landscape (Height is 0.6x width)
             fig_height_in = fig_width_in * 0.8
        
        plt.close('all')
        fig, (ax1, ax2) = plt.subplots(2, 1, figsize=(fig_width_in, fig_height_in), dpi=100, gridspec_kw={'height_ratios': [3, 1]})

        # Adjusted margins for better fit with dynamic sizing
        plt.subplots_adjust(left=0.05, right=0.98, bottom=0.1, top=0.95)

        ax1.add_patch(patches.Rectangle((-5, -7), 60, 7, color='deepskyblue', alpha=0.1))
        ax1.add_patch(patches.Rectangle((0, -target_depth-0.3), dist+4, 0.6, color='limegreen', alpha=0.3, label='Target'))
        ax1.axhline(0, color='dodgerblue', linewidth=2)
        ax1.axhline(p_bot, color='sienna', linewidth=3)
        
        ax1.plot(x, y, color=color, linewidth=3, label=line)
        ax1.axvline(trigger, color='purple', linestyle='--', alpha=0.5)
        
        # V50-2 Angler graphic
        rod_wrist_x = -1.2
        rod_wrist_y = 1.0
        ax1.add_patch(patches.Rectangle((-3, -0.5), 3, 0.5, color='#28a745', alpha=0.6)) # Land
        ax1.plot([-1.5, -1.5], [0.8, 1.5], 'k', lw=3)
        ax1.plot([-1.8, -1.5, -1.2], [0, 0.8, 0], 'k', lw=2)
        ax1.add_patch(patches.Circle((-1.5, 1.75), 0.25, color='k'))
        ax1.plot([-1.5, rod_wrist_x], [1.3, rod_wrist_y], 'k', lw=3) # Arm
        ax1.plot([rod_wrist_x, 0], [rod_wrist_y, rod_s], 'k', lw=3) # Rod
        if rod_dyn: ax1.plot([rod_wrist_x, 0], [rod_wrist_y, rod_e], 'gray', ls=':')
            
        if init_geo:
            ax1.plot([0, init_geo['entry_x']], [init_geo['rod_h'], 0], 'gray', ls='--', lw=1)
            ax1.plot([init_geo['entry_x'], init_geo['spoon_x']], [0, init_geo['spoon_y']], 'gray', ls='-', lw=1)

        ax1.set_ylim(-4.5, 2.5); ax1.set_xlim(dist+3, -3)
        ax1.set_ylabel("") 
        ax1.legend(loc='upper left', fontsize='small')
        ax1.grid(True, alpha=0.5, ls='--')
        
        ax2.plot(x, speeds, color='purple', lw=2, label="Speed")
        ax2.set_ylim(0, 150); ax2.set_yticks([]) 
        ax3 = ax2.twinx()
        ax3.plot(x, rod_heights, color='brown', ls='-.', lw=2, label="Rod")
        ax3.set_ylim(0, 4.0); ax3.set_yticks([]) 
        ax2.set_xlim(dist+3, -3); ax2.grid(True, alpha=0.3)
        lines_1, labels_1 = ax2.get_legend_handles_labels()
        lines_2, labels_2 = ax3.get_legend_handles_labels()
        ax2.legend(lines_1 + lines_2, labels_1 + labels_2, loc='upper left', fontsize='x-small')
        
        # Attitude
        step = 8
        q_x = x[::step]
        q_y = speeds[::step]
        q_ang = np.array(angles)[::step]
        rads = np.radians(q_ang)
        u = np.cos(rads)
        v = np.sin(rads)
        ax2.quiver(q_x, q_y, u, v, scale=30, width=0.005, headaxislength=0, headlength=0, pivot='mid', color='black')

        cranks_1 = ((dist - trigger) * 100) / reel_cm
        cranks_2 = (trigger * 100) / reel_cm
        rod_action = f"Lower to {rod_e}m" if rod_dyn else f"Hold Steady"
        target = -target_depth
        in_zone = [val for val in y if abs(val - target) <= 0.3]
        pct = (len(in_zone) / len(y)) * 100
        
        # V46 FIX: Safe String + One Border
        sheet_html = '<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">'
        sheet_html += f'<span style="font-weight:bold; font-size:1.1rem">üéØ Score: {pct:.0f}%</span>'
        sheet_html += f'<span style="color:#666">Reel: {reel_cm}cm</span></div>'
        sheet_html += '<hr style="border:0; border-top:1px solid #ccc; margin:5px 0;">'
        sheet_html += f'1. Cast <b>{dist}m</b>. Sink to <b>{start_depth}m</b>.<br>'
        sheet_html += f'2. <b>HOLD ROD {rod_s}m.</b> Reel <b>{cranks_1:.1f}x</b> ({int(spd_s)} cm/s)<br>'
        sheet_html += '<div style="background-color:#fff3cd; padding:5px; margin:5px 0; border-radius:4px;">'
        sheet_html += f'<b>‚ö° TRIGGER:</b> {rod_action} + Slow ({int(spd_e)} cm/s)</div>'
        sheet_html += f'4. Reel <b>{cranks_2:.1f}x</b> to finish.'

        # V48 UI-REWORK: Update both normal and sticky cheat sheets
        document.getElementById("cheat-sheet").innerHTML = sheet_html
        # The sticky one is a clone, find it by its new ID.
        sticky_sheet = document.getElementById("cheat-sheet-sticky")
        if sticky_sheet: sticky_sheet.innerHTML = sheet_html

        display(fig, target="plot-area", append=False)
        
    except Exception as e:
        log_error(e)

def run_auto_tune_handler(*args):
    try:
        dist = get_val("s_dist"); target = get_val("s_target"); wt = get_val("s_weight")
        shape = get_val("w_shape"); dia = get_val("s_dia"); leader = get_val("w_leader")
        line = get_val("w_line"); pond = -get_val("s_pond")
        
        res = optimize_technique(dist, target, wt, shape, dia, leader, line, pond)
        
        if res:
            set_val("s_spd_s", int(res['spd_s'])); set_val("s_spd_e", int(res['spd_e']))
            set_val("s_rod_s", res['rod_s']); set_val("s_rod_e", res['rod_e'])
            set_val("w_rod_dyn", res['rod_dyn']); set_val("s_start_d", round(res['start_depth'], 1))
            set_val("s_trig", int(res['trigger_dist']))
            update_plot_handler(None)
        else:
            document.getElementById("cheat-sheet").innerHTML = "<b>‚ùå SETUP IMPOSSIBLE. CHANGE GEAR.</b>"
    except Exception as e:
        log_error(e)

def update_plot_handler(*args):
    update_plot()

# --- V48 UI-REWORK: JAVASCRIPT HELPERS ---
def setup_ui_listeners():
    # Tab switching
    tabs = document.querySelectorAll('.tab-button')
    tab_contents = document.querySelectorAll('.tab-content')
    
    def switch_tab(e):
        for tab in tabs: tab.classList.remove('active')
        e.target.classList.add('active')
        
        for content in tab_contents: content.classList.remove('active')
        document.getElementById(e.target.dataset.tab + '-tab').classList.add('active')

    for tab in tabs:
        tab.addEventListener('click', create_proxy(switch_tab))

    # Slider tooltip
    sliders = document.querySelectorAll('input[type=range]')
    tooltip = document.getElementById('slider-tooltip')

    def show_tooltip(e):
        tooltip.style.display = 'block'
        update_tooltip(e)
    
    def hide_tooltip(e):
        tooltip.style.display = 'none'

    def update_tooltip(e):
        slider = e.target
        rect = slider.getBoundingClientRect()
        thumb_pos = (slider.value - slider.min) / (slider.max - slider.min)
        px_pos = rect.left + (thumb_pos * rect.width)
        
        tooltip.style.left = f'{px_pos}px'
        tooltip.style.top = f'{rect.top}px'
        tooltip.innerHTML = slider.value
    
    for slider in sliders:
        slider.addEventListener('input', create_proxy(update_tooltip))
        slider.addEventListener('mousedown', create_proxy(show_tooltip))
        slider.addEventListener('mouseup', create_proxy(hide_tooltip))
        slider.addEventListener('touchstart', create_proxy(show_tooltip))
        slider.addEventListener('touchend', create_proxy(hide_tooltip))

# --- V49 RESIZE FIX ---
_debounce_timer = None
def debounce_update_plot(e=None):
    global _debounce_timer
    if _debounce_timer:
        window.clearTimeout(_debounce_timer)
    
    # Using a proxy for the inner function that will be called by setTimeout
    _debounce_timer = window.setTimeout(create_proxy(update_plot), 150)

# --- BINDING HELPERS ---
update_proxy = create_proxy(update_plot)
auto_proxy = create_proxy(run_auto_tune_handler)

def bind_listeners():
    document.getElementById("btn-auto").addEventListener("click", auto_proxy)
    document.getElementById("btn-update").addEventListener("click", update_proxy)
    
    # V49 RESIZE FIX: Add listener for window resize
    window.addEventListener('resize', create_proxy(debounce_update_plot))

    # Clone cheat sheet container for sticky header
    original_container = document.getElementById("cheat-sheet-container")
    sticky_container = document.getElementById("cheat-sheet-container-sticky")
    if original_container and sticky_container:
        # Clone the #cheat-sheet div itself and give the clone a new ID
        original_sheet = original_container.querySelector("#cheat-sheet")
        cloned_sheet = original_sheet.cloneNode(True)
        cloned_sheet.id = "cheat-sheet-sticky"
        sticky_container.innerHTML = '' # Clear "Initializing..."
        sticky_container.appendChild(cloned_sheet)

    input_ids = [
        "w_line", "w_leader", "w_shape", 
        "s_weight", "i_weight",
        "s_dia", "i_dia",
        "s_reel", "i_reel",
        "s_dist", "i_dist",
        "s_target", "i_target",
        "s_pond", "i_pond",
        "s_start_d", "i_start_d",
        "s_trig", "i_trig",
        "s_spd_s", "i_spd_s",
        "s_spd_e", "i_spd_e",
        "s_rod_s", "i_rod_s",
        "s_rod_e", "i_rod_e",
        "w_rod_dyn"
    ]
    
    for id in input_ids:
        el = document.getElementById(id)
        if el:
            el.addEventListener("change", update_proxy)
            if el.type == "range": el.addEventListener("input", update_proxy)

bind_listeners()
setup_ui_listeners() # V48 UI-REWORK: Call the new UI setup
document.getElementById("loader").style.display = "none"
update_plot()
    </py-script>
</body>
</html>
